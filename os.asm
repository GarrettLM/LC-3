.ORIG x0000
; Trap Vector Table
; x0000 to x00FF
	.FILL undefined	;TRAP 0x00
	.FILL undefined	;TRAP 0x01
	.FILL undefined	;TRAP 0x02
	.FILL undefined	;TRAP 0x03
	.FILL undefined	;TRAP 0x04
	.FILL undefined	;TRAP 0x05
	.FILL undefined	;TRAP 0x06
	.FILL undefined	;TRAP 0x07
	.FILL undefined	;TRAP 0x08
	.FILL undefined	;TRAP 0x09
	.FILL undefined	;TRAP 0x0A
	.FILL undefined	;TRAP 0x0B
	.FILL undefined	;TRAP 0x0C
	.FILL undefined	;TRAP 0x0D
	.FILL undefined	;TRAP 0x0E
	.FILL undefined	;TRAP 0x0F
	.FILL undefined	;TRAP 0x10
	.FILL undefined	;TRAP 0x11
	.FILL undefined	;TRAP 0x12
	.FILL undefined	;TRAP 0x13
	.FILL undefined	;TRAP 0x14
	.FILL undefined	;TRAP 0x15
	.FILL undefined	;TRAP 0x16
	.FILL undefined	;TRAP 0x17
	.FILL undefined	;TRAP 0x18
	.FILL undefined	;TRAP 0x19
	.FILL undefined	;TRAP 0x1A
	.FILL undefined	;TRAP 0x1B
	.FILL undefined	;TRAP 0x1C
	.FILL undefined	;TRAP 0x1D
	.FILL undefined	;TRAP 0x1E
	.FILL undefined	;TRAP 0x1F
	.FILL getcTrap	;TRAP 0x20
	.FILL outTrap	;TRAP 0x21
	.FILL putsTrap	;TRAP 0x22
	.FILL inTrap	;TRAP 0x23
	.FILL putspTrap	;TRAP 0x24
	.FILL haltTrap	;TRAP 0x25
	.FILL undefined	;TRAP 0x26
	.FILL undefined	;TRAP 0x27
	.FILL undefined	;TRAP 0x28
	.FILL undefined	;TRAP 0x29
	.FILL undefined	;TRAP 0x2A
	.FILL undefined	;TRAP 0x2B
	.FILL undefined	;TRAP 0x2C
	.FILL undefined	;TRAP 0x2D
	.FILL undefined	;TRAP 0x2E
	.FILL undefined	;TRAP 0x2F
	.FILL undefined	;TRAP 0x30
	.FILL undefined	;TRAP 0x31
	.FILL undefined	;TRAP 0x32
	.FILL undefined	;TRAP 0x33
	.FILL undefined	;TRAP 0x34
	.FILL undefined	;TRAP 0x35
	.FILL undefined	;TRAP 0x36
	.FILL undefined	;TRAP 0x37
	.FILL undefined	;TRAP 0x38
	.FILL undefined	;TRAP 0x39
	.FILL undefined	;TRAP 0x3A
	.FILL undefined	;TRAP 0x3B
	.FILL undefined	;TRAP 0x3C
	.FILL undefined	;TRAP 0x3D
	.FILL undefined	;TRAP 0x3E
	.FILL undefined	;TRAP 0x3F
	.FILL undefined	;TRAP 0x40
	.FILL undefined	;TRAP 0x41
	.FILL undefined	;TRAP 0x42
	.FILL undefined	;TRAP 0x43
	.FILL undefined	;TRAP 0x44
	.FILL undefined	;TRAP 0x45
	.FILL undefined	;TRAP 0x46
	.FILL undefined	;TRAP 0x47
	.FILL undefined	;TRAP 0x48
	.FILL undefined	;TRAP 0x49
	.FILL undefined	;TRAP 0x4A
	.FILL undefined	;TRAP 0x4B
	.FILL undefined	;TRAP 0x4C
	.FILL undefined	;TRAP 0x4D
	.FILL undefined	;TRAP 0x4E
	.FILL undefined	;TRAP 0x4F
	.FILL undefined	;TRAP 0x50
	.FILL undefined	;TRAP 0x51
	.FILL undefined	;TRAP 0x52
	.FILL undefined	;TRAP 0x53
	.FILL undefined	;TRAP 0x54
	.FILL undefined	;TRAP 0x55
	.FILL undefined	;TRAP 0x56
	.FILL undefined	;TRAP 0x57
	.FILL undefined	;TRAP 0x58
	.FILL undefined	;TRAP 0x59
	.FILL undefined	;TRAP 0x5A
	.FILL undefined	;TRAP 0x5B
	.FILL undefined	;TRAP 0x5C
	.FILL undefined	;TRAP 0x5D
	.FILL undefined	;TRAP 0x5E
	.FILL undefined	;TRAP 0x5F
	.FILL undefined	;TRAP 0x60
	.FILL undefined	;TRAP 0x61
	.FILL undefined	;TRAP 0x62
	.FILL undefined	;TRAP 0x63
	.FILL undefined	;TRAP 0x64
	.FILL undefined	;TRAP 0x65
	.FILL undefined	;TRAP 0x66
	.FILL undefined	;TRAP 0x67
	.FILL undefined	;TRAP 0x68
	.FILL undefined	;TRAP 0x69
	.FILL undefined	;TRAP 0x6A
	.FILL undefined	;TRAP 0x6B
	.FILL undefined	;TRAP 0x6C
	.FILL undefined	;TRAP 0x6D
	.FILL undefined	;TRAP 0x6E
	.FILL undefined	;TRAP 0x6F
	.FILL undefined	;TRAP 0x70
	.FILL undefined	;TRAP 0x71
	.FILL undefined	;TRAP 0x72
	.FILL undefined	;TRAP 0x73
	.FILL undefined	;TRAP 0x74
	.FILL undefined	;TRAP 0x75
	.FILL undefined	;TRAP 0x76
	.FILL undefined	;TRAP 0x77
	.FILL undefined	;TRAP 0x78
	.FILL undefined	;TRAP 0x79
	.FILL undefined	;TRAP 0x7A
	.FILL undefined	;TRAP 0x7B
	.FILL undefined	;TRAP 0x7C
	.FILL undefined	;TRAP 0x7D
	.FILL undefined	;TRAP 0x7E
	.FILL undefined	;TRAP 0x7F
	.FILL undefined	;TRAP 0x80
	.FILL undefined	;TRAP 0x81
	.FILL undefined	;TRAP 0x82
	.FILL undefined	;TRAP 0x83
	.FILL undefined	;TRAP 0x84
	.FILL undefined	;TRAP 0x85
	.FILL undefined	;TRAP 0x86
	.FILL undefined	;TRAP 0x87
	.FILL undefined	;TRAP 0x88
	.FILL undefined	;TRAP 0x89
	.FILL undefined	;TRAP 0x8A
	.FILL undefined	;TRAP 0x8B
	.FILL undefined	;TRAP 0x8C
	.FILL undefined	;TRAP 0x8D
	.FILL undefined	;TRAP 0x8E
	.FILL undefined	;TRAP 0x8F
	.FILL undefined	;TRAP 0x90
	.FILL undefined	;TRAP 0x91
	.FILL undefined	;TRAP 0x92
	.FILL undefined	;TRAP 0x93
	.FILL undefined	;TRAP 0x94
	.FILL undefined	;TRAP 0x95
	.FILL undefined	;TRAP 0x96
	.FILL undefined	;TRAP 0x97
	.FILL undefined	;TRAP 0x98
	.FILL undefined	;TRAP 0x99
	.FILL undefined	;TRAP 0x9A
	.FILL undefined	;TRAP 0x9B
	.FILL undefined	;TRAP 0x9C
	.FILL undefined	;TRAP 0x9D
	.FILL undefined	;TRAP 0x9E
	.FILL undefined	;TRAP 0x9F
	.FILL undefined	;TRAP 0xA0
	.FILL undefined	;TRAP 0xA1
	.FILL undefined	;TRAP 0xA2
	.FILL undefined	;TRAP 0xA3
	.FILL undefined	;TRAP 0xA4
	.FILL undefined	;TRAP 0xA5
	.FILL undefined	;TRAP 0xA6
	.FILL undefined	;TRAP 0xA7
	.FILL undefined	;TRAP 0xA8
	.FILL undefined	;TRAP 0xA9
	.FILL undefined	;TRAP 0xAA
	.FILL undefined	;TRAP 0xAB
	.FILL undefined	;TRAP 0xAC
	.FILL undefined	;TRAP 0xAD
	.FILL undefined	;TRAP 0xAE
	.FILL undefined	;TRAP 0xAF
	.FILL undefined	;TRAP 0xB0
	.FILL undefined	;TRAP 0xB1
	.FILL undefined	;TRAP 0xB2
	.FILL undefined	;TRAP 0xB3
	.FILL undefined	;TRAP 0xB4
	.FILL undefined	;TRAP 0xB5
	.FILL undefined	;TRAP 0xB6
	.FILL undefined	;TRAP 0xB7
	.FILL undefined	;TRAP 0xB8
	.FILL undefined	;TRAP 0xB9
	.FILL undefined	;TRAP 0xBA
	.FILL undefined	;TRAP 0xBB
	.FILL undefined	;TRAP 0xBC
	.FILL undefined	;TRAP 0xBD
	.FILL undefined	;TRAP 0xBE
	.FILL undefined	;TRAP 0xBF
	.FILL undefined	;TRAP 0xC0
	.FILL undefined	;TRAP 0xC1
	.FILL undefined	;TRAP 0xC2
	.FILL undefined	;TRAP 0xC3
	.FILL undefined	;TRAP 0xC4
	.FILL undefined	;TRAP 0xC5
	.FILL undefined	;TRAP 0xC6
	.FILL undefined	;TRAP 0xC7
	.FILL undefined	;TRAP 0xC8
	.FILL undefined	;TRAP 0xC9
	.FILL undefined	;TRAP 0xCA
	.FILL undefined	;TRAP 0xCB
	.FILL undefined	;TRAP 0xCC
	.FILL undefined	;TRAP 0xCD
	.FILL undefined	;TRAP 0xCE
	.FILL undefined	;TRAP 0xCF
	.FILL undefined	;TRAP 0xD0
	.FILL undefined	;TRAP 0xD1
	.FILL undefined	;TRAP 0xD2
	.FILL undefined	;TRAP 0xD3
	.FILL undefined	;TRAP 0xD4
	.FILL undefined	;TRAP 0xD5
	.FILL undefined	;TRAP 0xD6
	.FILL undefined	;TRAP 0xD7
	.FILL undefined	;TRAP 0xD8
	.FILL undefined	;TRAP 0xD9
	.FILL undefined	;TRAP 0xDA
	.FILL undefined	;TRAP 0xDB
	.FILL undefined	;TRAP 0xDC
	.FILL undefined	;TRAP 0xDD
	.FILL undefined	;TRAP 0xDE
	.FILL undefined	;TRAP 0xDF
	.FILL undefined	;TRAP 0xE0
	.FILL undefined	;TRAP 0xE1
	.FILL undefined	;TRAP 0xE2
	.FILL undefined	;TRAP 0xE3
	.FILL undefined	;TRAP 0xE4
	.FILL undefined	;TRAP 0xE5
	.FILL undefined	;TRAP 0xE6
	.FILL undefined	;TRAP 0xE7
	.FILL undefined	;TRAP 0xE8
	.FILL undefined	;TRAP 0xE9
	.FILL undefined	;TRAP 0xEA
	.FILL undefined	;TRAP 0xEB
	.FILL undefined	;TRAP 0xEC
	.FILL undefined	;TRAP 0xED
	.FILL undefined	;TRAP 0xEE
	.FILL undefined	;TRAP 0xEF
	.FILL undefined	;TRAP 0xF0
	.FILL undefined	;TRAP 0xF1
	.FILL undefined	;TRAP 0xF2
	.FILL undefined	;TRAP 0xF3
	.FILL undefined	;TRAP 0xF4
	.FILL undefined	;TRAP 0xF5
	.FILL undefined	;TRAP 0xF6
	.FILL undefined	;TRAP 0xF7
	.FILL undefined	;TRAP 0xF8
	.FILL undefined	;TRAP 0xF9
	.FILL undefined	;TRAP 0xFA
	.FILL undefined	;TRAP 0xFB
	.FILL undefined	;TRAP 0xFC
	.FILL undefined	;TRAP 0xFD
	.FILL undefined	;TRAP 0xFE
	.FILL undefined	;TRAP 0xFF

; Interrupt Vector Table
; x0100 to x01FF
; Entries x0100 to x017F are pointers
; to the exception service routines
	.FILL privilegeException
	.FILL illegaleOpcodeException
	.BLKW 126
; Entries x0180 to x01FF are pointers
; to the interrupt service routines
	.FILL keyboardInterrupt
	.BLKW 127

TEMPR0
	.FILL x0
TEMPR1
	.FILL x0
TEMPR2
	.FILL x0
TEMPR3
	.FILL x0
TEMPR4
	.FILL x0
TEMPR5
	.FILL x0
TEMPR6
	.FILL x0
TEMPR7
	.FILL x0

getcTrap
	LDI R0,KBSRAddress	;Poll the KBSR until
	BRz getcTrap		;the user presses a key
	LDI R0,KBDRAddress	;load the ASCII character into R0
	RET

outTrap
	ST R1,TEMPR1	;Store the contents of R1
outLoop
	LDI R1,DSRAddress	;Poll the DSR until the
	BRz outLoop			;display is ready for output
	STI R0,DDRAddress	;Output the char to display
	LD R1,TEMPR1	;Restore the contents of R1
	RET

putsTrap
	ST R0,TEMPR0
	ST R1,TEMPR1
putsLoop
	LDI R1,DSRAddress	;Poll the DSR to determine
	BRz putsLoop		;if display is ready
	LDR R1,R0,#0	;Load the next char of string
	BRz putsEnd	;Check for the End of String char
	STI R1,DDRAddress	;Output char to display
	ADD R0,R0,#1	;Add one to the address for the next iteration
	BRnzp putsLoop
putsEnd
	LD R0,TEMPR0	;Restore the registers
	LD R1,TEMPR1
	RET

inTrap
	LDI R0,DSRAddress	;Poll the display until
	BRz inTrap			;its ready for output
inKBSRPoll				;A loop to poll the KBSR
	LDI	R0,KBSRAddress	;until the user has entered input
	BRz inKBSRPoll
	STI R0,DDRAddress	;Output the input to display
	RET

putspTrap
	ST R0,TEMPR0	;R0 is used hold the address of the current char pair
	ST R1,TEMPR1	;R1 will be used to hold the first char in a pair
	ST R2,TEMPR2	;R2 will be used to hold the second char in a pair
	ST R3,TEMPR3	;R3 will be used to hold temporary variables to split the char pair
putspLoop
	LD R3,putspMask
	AND R2,R1,R3
	NOT R3,R3
	AND R1,R1,R3
	BRz putspEnd
	ADD R3,R3,#1
	ADD R1,R1,R3
putspFirstPoll
	LDI R3,DSRAddress	;Poll the DSR to determine
	BRz putspFirstPoll		;if display is ready
	STI R1,DDRAddress
	ADD R2,R2,#0	;Check if the second char is the end of string
	BRz putspEnd
putspSecondPoll
	LDI R3,DSRAddress	;Poll the DSR to determine
	BRz putspSecondPoll		;if display is ready
	STI R2,DDRAddress	;Output char to display
	ADD R0,R0,#1	;Add one to the address for the next iteration
	BRnzp putspLoop
putspEnd
	LD R0,TEMPR0	;Restore the registers
	LD R1,TEMPR1
	LD R2,TEMPR2
	LD R3,TEMPR3
	RET
putspMask
	.FILL 0x00FF

undefined
	LEA R0,ErrorMessage
undefDSRPoll
	LDI R1,DSRAddress
	BRz undefDSRPoll
	LDR R1,R0,#0
	BRz haltTrap
	STI R1,DDRAddress
	ADD R0,R0,#1
	BRnzp undefDSRPoll

haltTrap
	LDI R0,MCRAddress
	LD R1,ClockDisable
	AND R0,R0,R1
	STI R0,MCRAddress
	RET

KBSRAddress
	.FILL xFE00
KBDRAddress
	.FILL xFE02
DSRAddress
	.FILL xFE04
DDRAddress
	.FILL xFE06
MCRAddress
	.FILL xFFFE
ClockDisable
	.FILL x7FFF
ErrorMessage
	.STRINGZ "Error: Undefined TRAP called!"

privilegeException
	RTI
illegaleOpcodeException
	RTI
keyboardInterrupt
	RTI
SupervisorStack
	.END
